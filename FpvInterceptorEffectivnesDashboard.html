<!DOCTYPE html><html lang="uk"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Дашборд: Ефективність FPV-Перехоплювачів</title>    <!-- Підключення бібліотек -->    <script src="https://cdn.tailwindcss.com"></script>    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>        <!-- Стилі -->    <style>        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #e5e7eb; }        .chart-container { position: relative; height: 40vh; width: 100%; }        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }        .kpi-value { font-size: 2.25rem; font-weight: 800; line-height: 1; }        .kpi-label { font-size: 0.875rem; color: #9ca3af; text-transform: uppercase; }        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; }        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }        /* Стилі для Воронки */        .html-funnel-container { display: flex; flex-direction: column; align-items: center; gap: 2px; width: 100%; height: 100%; min-height: 300px; justify-content: center; }        .funnel-segment { color: white; text-align: center; display: flex; justify-content: center; align-items: center; position: relative; transition: width 0.3s ease-in-out; padding: 12px 0; }        .funnel-segment-content { z-index: 10; }        .funnel-label { font-weight: bold; }        .funnel-value { font-size: 1.25rem; }        .funnel-percentage { font-size: 0.9rem; color: #d1d5db; }        #funnel-launches { background-color: rgba(59, 130, 246, 0.7); width: 100%; clip-path: polygon(0% 0, 100% 0, 92.5% 100%, 7.5% 100%); }        #funnel-detected { background-color: rgba(251, 191, 36, 0.7); width: 85%; clip-path: polygon(0% 0, 100% 0, 91.175% 100%, 8.825% 100%); }        #funnel-attempts { background-color: rgba(249, 115, 22, 0.7); width: 70%; clip-path: polygon(0% 0, 100% 0, 89.285% 100%, 10.715% 100%); }        #funnel-destroyed { background-color: rgba(34, 197, 94, 0.7); width: 55%; clip-path: polygon(0% 0, 100% 0, 86.36% 100%, 13.64% 100%); }    </style>    <link rel="preconnect" href="https://fonts.googleapis.com">    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"></head><body class="p-4 md:p-8">    <div class="container mx-auto">        <header class="text-center mb-8">            <h1 class="text-4xl font-bold text-white">Дашборд Ефективності FPV-Перехоплювачів</h1>            <p class="text-lg text-gray-400 mt-2">Аналіз ефективності вильотів та уражень</p>        </header>        <!-- Повідомлення про завантаження -->        <div id="loaderContainer" class="text-center p-10">            <div id="loader" class="loader"></div>            <div id="loadingMessage" class="text-center text-gray-400 mt-4">                <p>Завантаження даних з BigQuery...</p>            </div>        </div>        <!-- Контент Дашборду (прихований до завантаження) -->        <div id="dashboardContent" class="hidden">             <!-- Секція Фільтрів -->            <div class="card mb-8">                 <h2 class="text-xl font-semibold mb-4 text-white">Фільтри</h2>                 <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 items-end">                    <div><label for="dateStart" class="block text-sm font-medium text-gray-300 mb-1">Дата початку</label><input type="date" id="dateStart" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"></div>                    <div><label for="dateEnd" class="block text-sm font-medium text-gray-300 mb-1">Дата кінця</label><input type="date" id="dateEnd" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"></div>                    <div><label for="sectorFilter" class="block text-sm font-medium text-gray-300 mb-1">Сектор</label><select id="sectorFilter" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"></select></div>                    <div><label for="crewFilter" class="block text-sm font-medium text-gray-300 mb-1">Екіпаж</label><select id="crewFilter" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"></select></div>                    <div><label for="takeoffPointFilter" class="block text-sm font-medium text-gray-300 mb-1">Точка злету</label><select id="takeoffPointFilter" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"></select></div>                    <div><label for="targetTypeFilter" class="block text-sm font-medium text-gray-300 mb-1">Тип цілі</label><select id="targetTypeFilter" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"></select></div>                    <div class="flex flex-col gap-2">                        <button id="applyFiltersButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Застосувати</button>                        <button id="clearFiltersButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Очистити</button>                    </div>                 </div>            </div>            <!-- Абсолютні показники -->            <h3 class="text-lg font-semibold mb-4 text-gray-300">Абсолютні Показники</h3>            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">                <div class="card text-center"><div id="kpiLaunches" class="kpi-value text-blue-400">0</div><div class="kpi-label">Кількість пусків</div></div>                <div class="card text-center"><div id="kpiVisualContact" class="kpi-value text-yellow-400">0</div><div class="kpi-label">Візуальний контакт</div></div>                <div class="card text-center"><div id="kpiHitAttempts" class="kpi-value text-orange-400">0</div><div class="kpi-label">Спроба ураження</div></div>                <div class="card text-center"><div id="kpiDestroyed" class="kpi-value text-green-400">0</div><div class="kpi-label">Знищено</div></div>                <div class="card text-center"><div id="kpiNotDestroyed" class="kpi-value text-red-400">0</div><div class="kpi-label">Не знищено</div></div>                <div class="card text-center"><div id="kpiReturned" class="kpi-value text-gray-300">0</div><div class="kpi-label">Повернулось</div></div>            </div>            <!-- Ключові показники ефективності (KPI) -->            <h3 class="text-lg font-semibold mb-4 text-gray-300">Ключові Показники Ефективності (KPI)</h3>            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">                <div class="card text-center"><div id="kpiDetectionRate" class="kpi-value text-yellow-300">0%</div><div class="kpi-label">Ефективність виявлення (від пусків)</div></div>                <div class="card text-center"><div id="kpiHitAttemptRate" class="kpi-value text-orange-300">0%</div><div class="kpi-label">Ефективність спроб уражень (від виявлених)</div></div>                <div class="card text-center"><div id="kpiKillRate" class="kpi-value text-green-300">0%</div><div class="kpi-label">Ефективність знищення (від спроб)</div></div>                <div class="card text-center"><div id="kpiMissRate" class="kpi-value text-red-300">0%</div><div class="kpi-label">Відсоток промахів (від спроб)</div></div>            </div>            <!-- Графіки -->            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">                <!-- Воронка -->                <div class="card"><h3 class="text-lg font-semibold mb-4">Воронка ураження</h3>                    <div class="chart-container"><div id="funnelChart" class="html-funnel-container">                        <div id="funnel-launches" class="funnel-segment"><div class="funnel-segment-content"><div class="funnel-label">Пуски</div><div class="funnel-value" id="funnel-value-launches">0</div></div></div>                        <div id="funnel-detected" class="funnel-segment"><div class="funnel-segment-content"><div class="funnel-label">Візуальний контакт</div><div class="funnel-value" id="funnel-value-detected">0</div><div class="funnel-percentage" id="funnel-perc-detected">(0%)</div></div></div>                        <div id="funnel-attempts" class="funnel-segment"><div class="funnel-segment-content"><div class="funnel-label">Спроби ураження</div><div class="funnel-value" id="funnel-value-attempts">0</div><div class="funnel-percentage" id="funnel-perc-attempts">(0%)</div></div></div>                        <div id="funnel-destroyed" class="funnel-segment"><div class="funnel-segment-content"><div class="funnel-label">Знищено</div><div class="funnel-value" id="funnel-value-destroyed">0</div><div class="funnel-percentage" id="funnel-perc-destroyed">(0%)</div></div></div>                    </div></div>                </div>                <!-- Відсоткові показники ураження -->                <div class="card"><h3 class="text-lg font-semibold mb-4">Відсоткові показники ураження</h3><div class="chart-container"><canvas id="percentageMetricsChart"></canvas></div></div>                                <!-- Показники уражень по дням -->                <div class="card lg:col-span-2">                    <h3 class="text-lg font-semibold mb-4">Показники уражень по дням</h3>                    <div class="chart-container"><canvas id="dailyDynamicsChart"></canvas></div>                </div>                <!-- Ефективність по екіпажах -->                <div class="card"><h3 class="text-lg font-semibold mb-4">Ефективність по екіпажах (Топ 15)</h3><div class="chart-container" style="height: 50vh;"><canvas id="crewChart"></canvas></div></div>                <!-- Ефективність по точках злету -->                <div class="card"><h3 class="text-lg font-semibold mb-4">Ефективність по точках злету (Топ 15)</h3><div class="chart-container" style="height: 50vh;"><canvas id="takeoffPointChart"></canvas></div></div>                <!-- Знищено по типах БпЛА -->                <div class="card"><h3 class="text-lg font-semibold mb-4">Знищено по типах цілей</h3><div class="chart-container"><canvas id="targetTypeChart"></canvas></div></div>                <!-- Ефективність по напрямках -->                <div class="card"><h3 class="text-lg font-semibold mb-4">Ефективність по напрямках (Секторах)</h3><div class="chart-container"><canvas id="sectorChart"></canvas></div></div>            </div>        </div>    </div>    <!-- JavaScript Логіка -->    <script>    // --- Глобальний Стан ---    const AppState = {        charts: {}, // Об'єкт для зберігання екземплярів Chart.js        ui: { // Кешування UI елементів            loaderContainer: document.getElementById('loaderContainer'),            loadingMessage: document.getElementById('loadingMessage'),            dashboardContent: document.getElementById('dashboardContent'),            // Фільтри            dateStart: document.getElementById('dateStart'),            dateEnd: document.getElementById('dateEnd'),            sectorFilter: document.getElementById('sectorFilter'),            crewFilter: document.getElementById('crewFilter'),            takeoffPointFilter: document.getElementById('takeoffPointFilter'),            targetTypeFilter: document.getElementById('targetTypeFilter'),            applyFiltersButton: document.getElementById('applyFiltersButton'),            clearFiltersButton: document.getElementById('clearFiltersButton'),        },        // !!! ВАЖЛИВО: ВСТАВТЕ URL ВАШОГО WEB APP З GOOGLE APPS SCRIPT !!!        gasApiUrl: 'https://script.google.com/a/macros/nem412.com/s/AKfycbzPhALjT48oBOTsHQ0hwci5ybOHc3nwyU66K2URac_3-LXrHxayfQABZVcoRB47wUJ43g/exec'     };    // Глобальні налаштування Chart.js    Chart.defaults.color = '#9ca3af';    Chart.defaults.font.family = "'Inter', sans-serif";    Chart.register(ChartDataLabels);    // --- Ініціалізація Дашборду ---        window.onload = initializeDashboard;    /**     * Запускає завантаження фільтрів та даних при старті.     */    async function initializeDashboard() {        if (AppState.gasApiUrl === 'YOUR_GOOGLE_APPS_SCRIPT_DEPLOYMENT_URL_HERE') {            handleError('Будь ласка, вставте URL вашого Google Apps Script Web App у змінну AppState.gasApiUrl.');            return;        }                setLoadingState(true, 'Завантаження опцій фільтрів...');        try {            await populateFilters(); // Спочатку завантажуємо фільтри            await applyFilters();    // Потім завантажуємо дані з фільтрами за замовчуванням            setLoadingState(false);        } catch (error) {            handleError(error.message);        }    }    // --- Обробка Даних та API ---    /**     * Універсальна функція для виклику Google Apps Script.     */    async function fetchFromGas(params) {        const url = new URL(AppState.gasApiUrl);        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));                try {            const response = await fetch(url);            if (!response.ok) throw new Error(`Помилка мережі: ${response.statusText}`);                        const result = await response.json();            if (!result.success) throw new Error(`Помилка API: ${result.message}`);                        return result.data;        } catch (error) {            console.error('Помилка fetchFromGas:', error);            throw error; // Передаємо помилку далі        }    }    /**     * Завантажує унікальні значення для селектів (фільтрів).     */    async function populateFilters() {        const data = await fetchFromGas({ type: 'filters' });        // Функція-хелпер для заповнення <select>        const populateSelect = (selectEl, items, allLabel) => {            selectEl.innerHTML = `<option value="all">${allLabel}</option>`;            (items || []).filter(item => item).sort().forEach(item => {                const option = document.createElement('option');                option.value = item;                option.textContent = item;                selectEl.appendChild(option);            });        };        populateSelect(AppState.ui.sectorFilter, data.sectors, 'Всі сектори');        populateSelect(AppState.ui.crewFilter, data.crews, 'Всі екіпажі');        populateSelect(AppState.ui.takeoffPointFilter, data.takeoffPoints, 'Всі точки злету');        populateSelect(AppState.ui.targetTypeFilter, data.targetTypes, 'Всі типи цілей');                // Встановлення обробників подій        AppState.ui.applyFiltersButton.addEventListener('click', applyFilters);        AppState.ui.clearFiltersButton.addEventListener('click', resetFilters);    }    /**     * Збирає значення фільтрів, завантажує дані та оновлює дашборд.     */    async function applyFilters() {        setLoadingState(true, 'Агрегація даних в BigQuery...');                try {            const filters = {                type: 'data',                startDate: AppState.ui.dateStart.value,                endDate: AppState.ui.dateEnd.value,                sector: AppState.ui.sectorFilter.value,                crew: AppState.ui.crewFilter.value,                takeoffPoint: AppState.ui.takeoffPointFilter.value,                targetType: AppState.ui.targetTypeFilter.value,            };                        const data = await fetchFromGas(filters);            updateDashboard(data); // Оновлюємо весь дашборд            setLoadingState(false);        } catch (error) {            handleError(error.message);        }    }    /**     * Скидає всі фільтри до значень за замовчуванням і перезавантажує дані.     */    function resetFilters() {        AppState.ui.dateStart.value = '';        AppState.ui.dateEnd.value = '';        AppState.ui.sectorFilter.value = 'all';        AppState.ui.crewFilter.value = 'all';        AppState.ui.takeoffPointFilter.value = 'all';        AppState.ui.targetTypeFilter.value = 'all';        applyFilters();    }    // --- Оновлення UI ---    /**     * Головна функція оновлення UI. Викликає всі під-функції.     */    function updateDashboard(data) {        if (!data || !data.kpis) {            handleError("Отримано порожні або некоректні дані.");            return;        }        const kpis = data.kpis;                // Розрахунок KPI        const detectionRate = kpis.total_launches > 0 ? (kpis.visual_contact / kpis.total_launches) * 100 : 0;        const hitAttemptRate = kpis.visual_contact > 0 ? (kpis.hit_attempts / kpis.visual_contact) * 100 : 0;        const killRate = kpis.hit_attempts > 0 ? (kpis.targets_destroyed / kpis.hit_attempts) * 100 : 0;        const missRate = kpis.hit_attempts > 0 ? (kpis.misses_after_attempt / kpis.hit_attempts) * 100 : 0;                // Відсоткові показники        const percDetectedFromLaunches = kpis.total_launches > 0 ? (kpis.visual_contact / kpis.total_launches) * 100 : 0;        const percDestroyedFromAttempts = kpis.hit_attempts > 0 ? (kpis.targets_destroyed / kpis.hit_attempts) * 100 : 0;        const percDestroyedFromLaunches = kpis.total_launches > 0 ? (kpis.targets_destroyed / kpis.total_launches) * 100 : 0;        // Оновлення Абсолютних Показників        document.getElementById('kpiLaunches').textContent = kpis.total_launches.toLocaleString('uk-UA');        document.getElementById('kpiVisualContact').textContent = kpis.visual_contact.toLocaleString('uk-UA');        document.getElementById('kpiHitAttempts').textContent = kpis.hit_attempts.toLocaleString('uk-UA');        document.getElementById('kpiDestroyed').textContent = kpis.targets_destroyed.toLocaleString('uk-UA');        document.getElementById('kpiNotDestroyed').textContent = kpis.targets_not_destroyed.toLocaleString('uk-UA');        document.getElementById('kpiReturned').textContent = kpis.returned_safe.toLocaleString('uk-UA');        // Оновлення KPI        document.getElementById('kpiDetectionRate').textContent = `${detectionRate.toFixed(1)}%`;        document.getElementById('kpiHitAttemptRate').textContent = `${hitAttemptRate.toFixed(1)}%`;        document.getElementById('kpiKillRate').textContent = `${killRate.toFixed(1)}%`;        document.getElementById('kpiMissRate').textContent = `${missRate.toFixed(1)}%`;        // Оновлення Воронки        updateFunnelChart(kpis);        // Оновлення Графіків        updatePercentageMetricsChart({ percDetectedFromLaunches, percDestroyedFromAttempts, percDestroyedFromLaunches });        updateDailyDynamicsChart(data.dailyData || []);        updateCrewChart(data.crewData || []);        updateTakeoffPointChart(data.takeoffData || []);        updateTargetTypeChart(data.targetTypeData || []);        updateSectorChart(data.sectorData || []);    }    /**     * Управління станом завантажувача.     */    function setLoadingState(isLoading, message = 'Завантаження...') {        AppState.ui.loaderContainer.classList.toggle('hidden', !isLoading);        AppState.ui.dashboardContent.classList.toggle('hidden', isLoading);        if (isLoading) {            AppState.ui.loadingMessage.textContent = message;            AppState.ui.loadingMessage.classList.remove('text-red-400');        }    }    /**     * Обробка помилок.     */    function handleError(errorMessage) {        console.error('Помилка Дашборду:', errorMessage);        setLoadingState(true, errorMessage); // Показуємо помилку в блоці завантажувача        AppState.ui.loadingMessage.classList.add('text-red-400');        AppState.ui.loader.classList.add('hidden'); // Ховаємо сам спіннер    }    // --- Функції Побудови Графіків ---    /**     * Оновлює воронку.     */    function updateFunnelChart(kpis) {        const { total_launches, visual_contact, hit_attempts, targets_destroyed } = kpis;                // Розрахунок %        const percDetected = total_launches > 0 ? (visual_contact / total_launches * 100) : 0;        const percAttempts = visual_contact > 0 ? (hit_attempts / visual_contact * 100) : 0;        const percDestroyed = hit_attempts > 0 ? (targets_destroyed / hit_attempts * 100) : 0;        // Значення        document.getElementById('funnel-value-launches').textContent = total_launches.toLocaleString('uk-UA');        document.getElementById('funnel-value-detected').textContent = visual_contact.toLocaleString('uk-UA');        document.getElementById('funnel-value-attempts').textContent = hit_attempts.toLocaleString('uk-UA');        document.getElementById('funnel-value-destroyed').textContent = targets_destroyed.toLocaleString('uk-UA');                // Відсотки        document.getElementById('funnel-perc-detected').textContent = `(${percDetected.toFixed(1)}% від пусків)`;        document.getElementById('funnel-perc-attempts').textContent = `(${percAttempts.toFixed(1)}% від виявлених)`;        document.getElementById('funnel-perc-destroyed').textContent = `(${percDestroyed.toFixed(1)}% від спроб)`;                // Ширина сегментів        document.getElementById('funnel-detected').style.width = `${percDetected.toFixed(1)}%`;        document.getElementById('funnel-attempts').style.width = `${(percDetected * (percAttempts / 100)).toFixed(1)}%`;        document.getElementById('funnel-destroyed').style.width = `${(percDetected * (percAttempts / 100) * (percDestroyed / 100)).toFixed(1)}%`;    }    /**     * Оновлює графік "Відсоткові показники ураження".     */    function updatePercentageMetricsChart(data) {        const { percDetectedFromLaunches, percDestroyedFromAttempts, percDestroyedFromLaunches } = data;        const ctx = document.getElementById('percentageMetricsChart');        if (AppState.charts.percentageMetrics) AppState.charts.percentageMetrics.destroy();        AppState.charts.percentageMetrics = new Chart(ctx, {            type: 'bar',            data: {                labels: ['% Виявлених від Пусків', '% Знищення від Спроб', '% Знищення від Пусків'],                datasets: [{                    label: 'Ефективність',                    data: [percDetectedFromLaunches, percDestroyedFromAttempts, percDestroyedFromLaunches],                    backgroundColor: ['#eab308', '#16a34a', '#2563eb']                }]            },            options: getChartOptions({                indexAxis: 'y',                scales: { x: { max: 100, ticks: { callback: (v) => v + '%' } } },                plugins: {                     datalabels: { display: true, anchor: 'end', align: 'right', color: 'white', font: { weight: 'bold' }, formatter: (v) => `${v.toFixed(1)}%` },                    legend: { display: false }                }            })        });    }    /**     * Оновлює графік "Показники уражень по дням".     */    function updateDailyDynamicsChart(dailyData) {        const ctx = document.getElementById('dailyDynamicsChart');        if (AppState.charts.dailyDynamics) AppState.charts.dailyDynamics.destroy();                const labels = dailyData.map(d => d.flight_date);                AppState.charts.dailyDynamics = new Chart(ctx, {            type: 'bar',            data: {                labels,                datasets: [                    {                        label: 'Кількість пусків',                        data: dailyData.map(d => d.total_launches),                        backgroundColor: 'rgba(59, 130, 246, 0.7)',                        yAxisID: 'yLaunches'                    },                    {                        label: 'Кількість знищених',                        data: dailyData.map(d => d.targets_destroyed),                        backgroundColor: 'rgba(34, 197, 94, 0.7)',                        yAxisID: 'yLaunches'                    }                ]            },            options: getChartOptions({                scales: {                     yLaunches: {                         type: 'linear',                         position: 'left',                        title: { display: true, text: 'Кількість' }                    }                 }            })        });    }    /**     * Оновлює горизонтальний бар "Ефективність по екіпажах".     */    function updateCrewChart(crewData) {        const ctx = document.getElementById('crewChart');        if (AppState.charts.crew) AppState.charts.crew.destroy();                const data = crewData.slice(0, 15); // Тільки Топ 15        AppState.charts.crew = new Chart(ctx, {            type: 'bar',            data: {                labels: data.map(d => d.crew),                datasets: [{                    label: 'Знищено',                    data: data.map(d => d.targets_destroyed),                    backgroundColor: '#16a34a'                }, {                    label: 'Пуски (всього)',                    data: data.map(d => d.total_launches),                    backgroundColor: '#3b82f6'                }]            },            options: getHorizontalBarOptions(data)        });    }    /**     * Оновлює горизонтальний бар "Ефективність по точках злету".     */    function updateTakeoffPointChart(takeoffData) {        const ctx = document.getElementById('takeoffPointChart');        if (AppState.charts.takeoffPoint) AppState.charts.takeoffPoint.destroy();                const data = takeoffData.slice(0, 15); // Тільки Топ 15        AppState.charts.takeoffPoint = new Chart(ctx, {            type: 'bar',            data: {                labels: data.map(d => d.takeoff_point),                datasets: [{                    label: 'Знищено',                    data: data.map(d => d.targets_destroyed),                    backgroundColor: '#d97706'                }, {                    label: 'Пуски (всього)',                    data: data.map(d => d.total_launches),                    backgroundColor: '#6b7280'                }]            },            options: getHorizontalBarOptions(data)        });    }    /**     * Оновлює кругову діаграму "Знищено по типах цілей".     */    function updateTargetTypeChart(targetTypeData) {        const ctx = document.getElementById('targetTypeChart');        if (AppState.charts.targetType) AppState.charts.targetType.destroy();                const total = targetTypeData.reduce((sum, d) => sum + d.targets_destroyed, 0);        AppState.charts.targetType = new Chart(ctx, {            type: 'doughnut',            data: {                labels: targetTypeData.map(d => d.target_type),                datasets: [{                    data: targetTypeData.map(d => d.targets_destroyed),                    backgroundColor: ['#c026d3', '#db2777', '#ea580c', '#0284c7', '#16a34a', '#ca8a04']                }]            },            options: getDoughnutOptions(total)        });    }    /**     * Оновлює кругову діаграму "Ефективність по напрямках".     */    function updateSectorChart(sectorData) {        const ctx = document.getElementById('sectorChart');        if (AppState.charts.sector) AppState.charts.sector.destroy();                const total = sectorData.reduce((sum, d) => sum + d.targets_destroyed, 0);        AppState.charts.sector = new Chart(ctx, {            type: 'doughnut',            data: {                labels: sectorData.map(d => d.sector),                datasets: [{                    data: sectorData.map(d => d.targets_destroyed),                    backgroundColor: ['#2563eb', '#65a30d', '#f59e0b', '#e11d48', '#7c3aed', '#0d9488']                }]            },            options: getDoughnutOptions(total)        });    }    // --- Хелпери для Графіків ---    /**     * Повертає базові опції для графіків.     */    function getChartOptions(customOptions = {}) {        const options = {            responsive: true,            maintainAspectRatio: false,            plugins: {                legend: { position: 'top', labels: { color: '#e5e7eb' } },                datalabels: { display: false } // Вимкнено за замовчуванням            },            scales: {                x: { grid: { display: false }, ticks: { color: '#9ca3af' } },                y: { grid: { color: '#374151' }, ticks: { beginAtZero: true, color: '#9ca3af' } }            }        };        // Глибоке злиття опцій (простий варіант)        Object.assign(options, customOptions);        if (customOptions.scales) Object.assign(options.scales, customOptions.scales);        if (customOptions.plugins) Object.assign(options.plugins, customOptions.plugins);        return options;    }    /**     * Повертає опції для горизонтальних бар-чартів (Екіпажі, Точки злету).     */    function getHorizontalBarOptions(data) {        return getChartOptions({            indexAxis: 'y',            scales: { x: { stacked: true }, y: { stacked: true } },            plugins: {                tooltip: {                    callbacks: {                        label: function(context) {                            const i = context.dataIndex;                            const crewData = data[i];                            const efficiency = crewData.total_launches > 0 ? (crewData.targets_destroyed / crewData.total_launches * 100) : 0;                            return `${context.dataset.label}: ${context.raw} (Ефективність: ${efficiency.toFixed(1)}%)`;                        }                    }                },                legend: { position: 'bottom' }            }        });    }    /**     * Повертає опції для кругових діаграм.     */    function getDoughnutOptions(total) {        return {            responsive: true,            maintainAspectRatio: false,            plugins: {                legend: { position: 'right', labels: { boxWidth: 20, color: '#e5e7eb' } },                datalabels: {                    color: 'white',                    textAlign: 'center',                    font: { weight: 'bold', size: 11 },                    formatter: (value) => {                        const p = total > 0 ? (value / total * 100) : 0;                        if (p < 4) return null; // Не показувати мітки для малих значень                        return `${value}\n(${p.toFixed(0)}%)`;                    }                }            }        };    }    </script></body></html>